name: PKHeX-Build
on: [push, workflow_dispatch]
permissions:
  contents: write
jobs:
  build:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x
      - run: dotnet restore PKHeX.sln
      - run: dotnet build PKHeX.sln --configuration Release --no-restore
      - run: dotnet publish PKHeX.WinForms/PKHeX.WinForms.csproj -c Release -o ./publish

      - name: Download All Plugins
        run: |
          mkdir ./publish/plugins

          # Download from hexbyt3 PKHeXth (AutoMod, LivingDex, Spinda)
          $hexbyt3Plugins = @(
            "AutoModPlugins.dll",
            "PKHeX.Plugin.LivingDex.dll",
            "SpindaPatternPlugin.dll"
          )
          foreach ($plugin in $hexbyt3Plugins) {
            $url = "https://raw.githubusercontent.com/hexbyt3/PKHeXth/master/PKHeX.WinForms/MainWindow/Plugins/$plugin"
            Invoke-WebRequest -Uri $url -OutFile "./publish/plugins/$plugin"
            Write-Host "Downloaded from hexbyt3: $plugin"
          }

          # Download Seed Finders from PKM-Universe (our own repo!)
          $seedFinderPlugins = @(
            "PLZASeedFinderPlugin.dll",
            "SVSeedFinderPlugin.dll",
            "SWSHSeedFinderPlugin.dll"
          )

          # Get latest release from PKM-Universe Seed Finder repo
          $releaseUrl = "https://api.github.com/repos/PKM-Universe/-PKM-Universe-Seed-Finder/releases/latest"
          $release = Invoke-RestMethod -Uri $releaseUrl -Headers @{"Accept"="application/vnd.github.v3+json"}

          foreach ($plugin in $seedFinderPlugins) {
            $asset = $release.assets | Where-Object { $_.name -eq $plugin }
            if ($asset) {
              Invoke-WebRequest -Uri $asset.browser_download_url -OutFile "./publish/plugins/$plugin"
              Write-Host "Downloaded from PKM-Universe: $plugin"
            }
          }
        shell: pwsh

      - name: Get Version with Revision
        id: version
        run: |
          $date = Get-Date -Format "yy.MM.dd"
          $baseTag = "v$date"

          # Get existing tags for today
          $existingTags = git tag -l "$baseTag*" 2>$null

          if ($existingTags) {
            # Find highest revision
            $maxRev = 0
            foreach ($tag in $existingTags) {
              if ($tag -match "rev\.(\d+)") {
                $rev = [int]$matches[1]
                if ($rev -gt $maxRev) { $maxRev = $rev }
              }
            }
            $newRev = $maxRev + 1
            $version = "$date-rev.$newRev"
          } else {
            $version = $date
          }

          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"
        shell: pwsh

      - name: Generate Changelog
        id: changelog
        run: |
          $lastTag = git describe --tags --abbrev=0 2>$null
          if ($lastTag) {
            $changes = git log "$lastTag..HEAD" --pretty=format:"- %s" 2>$null
          } else {
            $changes = git log -10 --pretty=format:"- %s" 2>$null
          }

          if (-not $changes) { $changes = "- Initial release" }

          # Write to file for multiline output
          $changes | Out-File -FilePath changelog.txt -Encoding utf8
          echo "Generated changelog"
        shell: pwsh

      - name: Create ZIP Package
        run: |
          Compress-Archive -Path ./publish/* -DestinationPath ./PKM-Universe-v${{ steps.version.outputs.VERSION }}.zip
        shell: pwsh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: PKM-Universe v${{ steps.version.outputs.VERSION }}
          files: |
            ./PKM-Universe-v${{ steps.version.outputs.VERSION }}.zip
            ./publish/PKHeX.exe
            ./publish/PKHeX.Core.dll
          body: |
            ## Plugin Updates
            - Updated plugin resources
            - PKHeX.exe has been updated
            - PKHeX.Core.dll has been updated

            This is a PKM-Universe release with all plugins included.

            ## ‚ú® What's Included
            - Custom Red Theme
            - Auto-Legality Mod Plugin
            - Living Dex Generator
            - Seed Finder Plugins (SV, SWSH, PLZA)
            - Spinda Pattern Plugin
            - Batch Editor & More!

            ## üì• Assets
            - **PKM-Universe.zip** - Full package with all plugins
            - **PKHeX.exe** - Main executable
            - **PKHeX.Core.dll** - Core library

            ---
            Made with ‚ù§Ô∏è by PKM-Universe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/upload-artifact@v4
        with:
          name: PKM-Universe-v${{ steps.version.outputs.VERSION }}
          path: ./publish/
